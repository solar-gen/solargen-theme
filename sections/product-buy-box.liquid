{%- comment -%}
  Product Buy Box - Verfügbarkeit & Versand Panel
  Klassischer Versandhaus-Look für Produktseiten
{%- endcomment -%}

{%- liquid
  assign product_available = product.available
  assign inventory_qty = product.selected_or_first_available_variant.inventory_quantity
  assign low_stock_threshold = section.settings.low_stock_threshold | default: 10
  
  # Status-Logik
  assign stock_status = 'in_stock'
  if product_available == false
    assign stock_status = 'out_of_stock'
  elsif inventory_qty <= low_stock_threshold and inventory_qty > 0
    assign stock_status = 'low_stock'
  endif
  
  # Metafields mit Fallbacks
  assign free_shipping = product.metafields.custom.free_shipping | default: false
  assign delivery_text = product.metafields.custom.delivery_text | default: 'Lieferzeit: 3–7 Werktage'
  assign cheaper_contact_url = product.metafields.custom.cheaper_contact_url | default: '/pages/preisgarantie'
  assign pickup_location = shop.metafields.custom.pickup_location
  assign pickup_ready_hours = shop.metafields.custom.pickup_ready_hours | default: 0
  
  # Section Settings
  assign show_price_guarantee = section.settings.show_price_guarantee | default: true
  assign shipping_policy_url = section.settings.shipping_policy_url | default: '/policies/shipping-policy'
  assign position = section.settings.position | default: 'below_price'
  
  # Farben
  assign color_primary = section.settings.color_primary | default: '#16A34A'
  assign color_warning = section.settings.color_warning | default: '#F59E0B'
  assign color_danger = section.settings.color_danger | default: '#DC2626'
  assign color_info = section.settings.color_info | default: '#2563EB'
-%}

<div class="pbbox-container" {{ block.shopify_attributes }}>
  <div class="pbbox-card">
    <!-- Header -->
    <div class="pbbox-header">
      <div class="pbbox-header-content">
        <svg class="pbbox-header-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" role="img" aria-label="Schutzschild">
          <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
          <path d="M9 12l2 2 4-4"/>
        </svg>
        <h3 class="pbbox-header-title">Verfügbarkeit & Versand</h3>
      </div>
    </div>

    <div class="pbbox-content">
      <!-- Status-Badge -->
      <div class="pbbox-status">
        <div class="pbbox-status-dot pbbox-status-dot--{{ stock_status }}" role="status" aria-label="Lagerstatus">
          {%- case stock_status -%}
            {%- when 'in_stock' -%}
              <svg class="pbbox-status-icon" viewBox="0 0 24 24" fill="currentColor" role="img" aria-label="Verfügbar">
                <circle cx="12" cy="12" r="10"/>
              </svg>
            {%- when 'low_stock' -%}
              <svg class="pbbox-status-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" role="img" aria-label="Wenig verfügbar">
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12,6 12,12 16,14"/>
              </svg>
            {%- when 'out_of_stock' -%}
              <svg class="pbbox-status-icon" viewBox="0 0 24 24" fill="currentColor" role="img" aria-label="Nicht verfügbar">
                <circle cx="12" cy="12" r="10"/>
              </svg>
          {%- endcase -%}
        </div>
        <span class="pbbox-status-text pbbox-status-text--{{ stock_status }}">
          {%- case stock_status -%}
            {%- when 'in_stock' -%}
              Auf Lager
            {%- when 'low_stock' -%}
              Nur noch {{ inventory_qty }} auf Lager
            {%- when 'out_of_stock' -%}
              Derzeit nicht auf Lager
          {%- endcase -%}
        </span>
      </div>

      <!-- Versand & Abholung Grid -->
      <div class="pbbox-grid">
        <!-- Versand-Spalte -->
        <div class="pbbox-column">
          <div class="pbbox-shipping-main">
            {%- if free_shipping -%}
              <span class="pbbox-shipping-free">Versandkostenfrei</span>
            {%- else -%}
              <div class="pbbox-shipping-costs">
                <span>zzgl. Versandkosten</span>
                <a href="{{ shipping_policy_url }}" class="pbbox-shipping-link">Details</a>
              </div>
            {%- endif -%}
          </div>
          <div class="pbbox-delivery-text">{{ delivery_text }}</div>
          <div class="pbbox-shipping-info">Versand mit DHL/DPD – Sendungsverfolgung</div>
        </div>

        <!-- Abholung-Spalte -->
        {%- if pickup_location -%}
          <div class="pbbox-column">
            <div class="pbbox-pickup-main">Abholung möglich</div>
            <div class="pbbox-pickup-location">{{ pickup_location }}</div>
            {%- if pickup_ready_hours > 0 -%}
              <div class="pbbox-pickup-ready">bereit in {{ pickup_ready_hours }} h</div>
            {%- endif -%}
          </div>
        {%- endif -%}
      </div>

      <!-- Preisgarantie -->
      {%- if show_price_guarantee -%}
        <div class="pbbox-guarantee">
          <svg class="pbbox-guarantee-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" role="img" aria-label="Kontakt">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
          </svg>
          <a href="{{ cheaper_contact_url }}" class="pbbox-guarantee-link">
            Diesen Artikel günstiger gefunden? Kontaktieren Sie uns!
          </a>
        </div>
      {%- endif -%}

      <!-- Trust-Footer -->
      <div class="pbbox-footer">
        <div class="pbbox-footer-item">
          <svg class="pbbox-footer-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" role="img" aria-label="Rückgabe">
            <path d="M3 7v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2H5a2 2 0 0 0-2-2z"/>
            <path d="M8 5a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2H8V5z"/>
          </svg>
          <span>30 Tage Rückgabe</span>
        </div>
        <div class="pbbox-footer-item">
          <svg class="pbbox-footer-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" role="img" aria-label="Käuferschutz">
            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
          </svg>
          <span>Käuferschutz</span>
        </div>
        <div class="pbbox-footer-item">
          <svg class="pbbox-footer-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" role="img" aria-label="Sichere Zahlung">
            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
            <line x1="8" y1="21" x2="16" y2="21"/>
            <line x1="12" y1="17" x2="12" y2="21"/>
          </svg>
          <span>Sichere Zahlung</span>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
/* ===== PRODUCT BUY BOX STYLES ===== */
.pbbox-container {
  margin: 20px 0;
}

.pbbox-card {
  background: #ffffff;
  border: 1px solid #E5E7EB;
  border-radius: 10px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
  overflow: hidden;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

/* Header */
.pbbox-header {
  background: linear-gradient(to right, #F8FAFC, #F1F5F9);
  padding: 16px 20px;
  border-bottom: 1px solid #E5E7EB;
}

.pbbox-header-content {
  display: flex;
  align-items: center;
  gap: 10px;
}

.pbbox-header-icon {
  width: 22px;
  height: 22px;
  color: #2563EB;
  flex-shrink: 0;
}

.pbbox-header-title {
  font-weight: 600;
  color: #111827;
  margin: 0;
  font-size: 18px;
  line-height: 1.2;
}

/* Content */
.pbbox-content {
  padding: 24px 20px;
  line-height: 1.6;
}

/* Status */
.pbbox-status {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 20px;
}

.pbbox-status-dot {
  width: 14px;
  height: 14px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.pbbox-status-dot--in_stock {
  background: {{ color_primary }};
  color: #ffffff;
}

.pbbox-status-dot--low_stock {
  background: {{ color_warning }};
  color: #ffffff;
}

.pbbox-status-dot--out_of_stock {
  background: {{ color_danger }};
  color: #ffffff;
}

.pbbox-status-icon {
  width: 8px;
  height: 8px;
}

.pbbox-status-text {
  font-weight: 600;
  font-size: 16px;
}

.pbbox-status-text--in_stock {
  color: {{ color_primary }};
}

.pbbox-status-text--low_stock {
  color: {{ color_warning }};
}

.pbbox-status-text--out_of_stock {
  color: {{ color_danger }};
}

/* Grid */
.pbbox-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 20px;
  margin-bottom: 20px;
}

@media (min-width: 640px) {
  .pbbox-grid {
    grid-template-columns: 1fr 1fr;
  }
}

.pbbox-column {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

/* Versand */
.pbbox-shipping-main {
  font-weight: 600;
  color: #111827;
  font-size: 16px;
}

.pbbox-shipping-free {
  color: {{ color_primary }};
}

.pbbox-shipping-costs {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

.pbbox-shipping-link {
  color: {{ color_info }};
  text-decoration: underline;
  font-size: 14px;
  font-weight: 400;
}

.pbbox-shipping-link:hover {
  color: #1D4ED8;
}

.pbbox-delivery-text {
  font-size: 14px;
  color: #6B7280;
}

.pbbox-shipping-info {
  font-size: 12px;
  color: #9CA3AF;
}

/* Abholung */
.pbbox-pickup-main {
  font-weight: 600;
  color: #111827;
  font-size: 16px;
}

.pbbox-pickup-location {
  font-size: 14px;
  color: #6B7280;
}

.pbbox-pickup-ready {
  font-size: 12px;
  color: {{ color_primary }};
  font-weight: 500;
}

/* Preisgarantie */
.pbbox-guarantee {
  background: #E1EEFF;
  border: 1px solid #B3D9FF;
  border-radius: 8px;
  padding: 16px;
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 20px;
}

.pbbox-guarantee-icon {
  width: 18px;
  height: 18px;
  color: {{ color_info }};
  flex-shrink: 0;
}

.pbbox-guarantee-link {
  color: #1D4ED8;
  font-weight: 500;
  font-size: 14px;
  text-decoration: none;
}

.pbbox-guarantee-link:hover {
  color: #1E40AF;
  text-decoration: underline;
}

/* Footer */
.pbbox-footer {
  padding-top: 16px;
  border-top: 1px solid #E5E7EB;
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 20px;
  font-size: 13px;
  color: #6B7280;
}

.pbbox-footer-item {
  display: flex;
  align-items: center;
  gap: 6px;
}

.pbbox-footer-icon {
  width: 14px;
  height: 14px;
  flex-shrink: 0;
}

/* Responsive */
@media (max-width: 639px) {
  .pbbox-content {
    padding: 20px 16px;
  }
  
  .pbbox-header {
    padding: 14px 16px;
  }
  
  .pbbox-footer {
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
  }
  
  .pbbox-shipping-costs {
    flex-direction: column;
    align-items: flex-start;
    gap: 4px;
  }
}
</style>

{% schema %}
{
  "name": "Product Buy Box",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "header",
      "content": "Anzeige-Einstellungen"
    },
    {
      "type": "select",
      "id": "position",
      "label": "Position",
      "options": [
        {
          "value": "below_price",
          "label": "Unter dem Preis"
        },
        {
          "value": "below_cta",
          "label": "Unter dem Kauf-Button"
        }
      ],
      "default": "below_price"
    },
    {
      "type": "checkbox",
      "id": "show_price_guarantee",
      "label": "Preisgarantie anzeigen",
      "default": true
    },
    {
      "type": "url",
      "id": "shipping_policy_url",
      "label": "Versandkosten-Details URL"
    },
    {
      "type": "range",
      "id": "low_stock_threshold",
      "label": "Schwellenwert für 'Wenig Lager'",
      "min": 1,
      "max": 50,
      "step": 1,
      "default": 10
    },
    {
      "type": "header",
      "content": "Farben"
    },
    {
      "type": "color",
      "id": "color_primary",
      "label": "Primärfarbe (Verfügbar)",
      "default": "#16A34A"
    },
    {
      "type": "color",
      "id": "color_warning",
      "label": "Warnfarbe (Wenig Lager)",
      "default": "#F59E0B"
    },
    {
      "type": "color",
      "id": "color_danger",
      "label": "Gefahrfarbe (Nicht verfügbar)",
      "default": "#DC2626"
    },
    {
      "type": "color",
      "id": "color_info",
      "label": "Infofarbe (Links)",
      "default": "#2563EB"
    }
  ],
  "presets": [
    {
      "name": "Product Buy Box"
    }
  ]
}
{% endschema %}
